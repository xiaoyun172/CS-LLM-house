name: iOS Build

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

permissions:
  contents: write
  packages: write

jobs:
  build:
    runs-on: macos-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'

      - name: Clear npm cache
        run: npm cache clean --force

      - name: Install Dependencies with retry
        run: |
          # å°è¯•å¤šç§æ–¹æ³•å®‰è£…ä¾èµ–
          echo "Attempting npm ci..."
          npm ci || {
            echo "npm ci failed, trying alternative approaches..."
            echo "Cleaning up and retrying..."
            rm -rf node_modules package-lock.json
            npm cache clean --force

            echo "Trying npm install with --no-package-lock..."
            npm install --no-package-lock || {
              echo "npm install failed, trying with --legacy-peer-deps..."
              npm install --legacy-peer-deps || {
                echo "All npm methods failed, trying yarn as fallback..."
                npm install -g yarn
                yarn install --ignore-engines
              }
            }
          }

      - name: Build Web App
        run: npm run build

      - name: Set up Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: latest-stable

      - name: Install CocoaPods
        run: sudo gem install cocoapods

      - name: Sync Capacitor iOS
        run: npx cap sync ios

      - name: Update iOS project settings
        run: |
          cd ios/App

          # åˆ›å»ºä¸€ä¸ªæ›´å®‰å…¨çš„é¡¹ç›®é…ç½®è„šæœ¬
          cat > update_project.py << 'EOF'
          import re
          import sys

          def update_pbxproj(file_path):
              try:
                  with open(file_path, 'r') as f:
                      content = f.read()

                  # æ›´å®‰å…¨çš„æ›¿æ¢æ–¹å¼
                  # ç¦ç”¨ä»£ç ç­¾å
                  content = re.sub(r'CODE_SIGN_STYLE = Automatic;', 'CODE_SIGN_STYLE = Manual;', content)
                  content = re.sub(r'DEVELOPMENT_TEAM = [^;]*;', 'DEVELOPMENT_TEAM = "";', content)
                  content = re.sub(r'CODE_SIGN_IDENTITY = [^;]*;', 'CODE_SIGN_IDENTITY = "";', content)
                  content = re.sub(r'PROVISIONING_PROFILE_SPECIFIER = [^;]*;', 'PROVISIONING_PROFILE_SPECIFIER = "";', content)

                  # æ·»åŠ ç¦ç”¨ä»£ç ç­¾åçš„è®¾ç½®
                  if 'CODE_SIGNING_ALLOWED' not in content:
                      # åœ¨æ„å»ºè®¾ç½®éƒ¨åˆ†æ·»åŠ 
                      content = re.sub(
                          r'(buildSettings = \{[^}]*)',
                          r'\1\n\t\t\t\tCODE_SIGNING_ALLOWED = NO;',
                          content
                      )

                  with open(file_path, 'w') as f:
                      f.write(content)

                  print("Project file updated successfully")
                  return True
              except Exception as e:
                  print(f"Error updating project file: {e}")
                  return False

          if __name__ == "__main__":
              success = update_pbxproj("App.xcodeproj/project.pbxproj")
              sys.exit(0 if success else 1)
          EOF

          # è¿è¡Œ Python è„šæœ¬æ›´æ–°é¡¹ç›®
          python3 update_project.py

      - name: List available schemes
        run: |
          cd ios/App
          echo "Available schemes:"
          xcodebuild -workspace App.xcworkspace -list

      - name: Build iOS App (Archive)
        run: |
          cd ios/App

          # åˆ›å»ºæ„å»ºç›®å½•
          mkdir -p build

          # å°è¯•æ„å»ºå½’æ¡£ï¼Œä½¿ç”¨æ›´ç®€å•çš„å‚æ•°
          xcodebuild archive \
            -workspace App.xcworkspace \
            -scheme App \
            -configuration Release \
            -archivePath ./build/App.xcarchive \
            -destination generic/platform=iOS \
            CODE_SIGNING_ALLOWED=NO \
            CODE_SIGN_IDENTITY="" \
            PROVISIONING_PROFILE="" \
            DEVELOPMENT_TEAM="" || {
              echo "Archive failed, trying with different scheme name..."
              # å¦‚æœå¤±è´¥ï¼Œå°è¯•ä½¿ç”¨å…¶ä»–å¯èƒ½çš„ scheme åç§°
              xcodebuild archive \
                -workspace App.xcworkspace \
                -scheme "App (iOS)" \
                -configuration Release \
                -archivePath ./build/App.xcarchive \
                -destination generic/platform=iOS \
                CODE_SIGNING_ALLOWED=NO \
                CODE_SIGN_IDENTITY="" \
                PROVISIONING_PROFILE="" \
                DEVELOPMENT_TEAM=""
            }

      - name: Export IPA (Unsigned)
        run: |
          cd ios/App

          # æ£€æŸ¥å½’æ¡£æ˜¯å¦å­˜åœ¨
          if [ ! -d "./build/App.xcarchive" ]; then
            echo "Archive not found, cannot export IPA"
            exit 1
          fi

          # åˆ›å»ºæ›´ç®€å•çš„å¯¼å‡ºé€‰é¡¹
          cat > ExportOptions.plist << EOF
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
          <dict>
              <key>method</key>
              <string>development</string>
              <key>compileBitcode</key>
              <false/>
              <key>signingStyle</key>
              <string>manual</string>
              <key>stripSwiftSymbols</key>
              <true/>
              <key>thinning</key>
              <string>&lt;none&gt;</string>
              <key>signingCertificate</key>
              <string>-</string>
              <key>provisioningProfiles</key>
              <dict/>
          </dict>
          </plist>
          EOF

          # å°è¯•å¯¼å‡ºIPA
          xcodebuild -exportArchive \
            -archivePath ./build/App.xcarchive \
            -exportPath ./build \
            -exportOptionsPlist ExportOptions.plist || {
              echo "Export failed, trying alternative method..."
              # å¦‚æœå¯¼å‡ºå¤±è´¥ï¼Œå°è¯•ç›´æ¥ä»å½’æ¡£ä¸­æå–
              if [ -d "./build/App.xcarchive/Products/Applications" ]; then
                echo "Extracting app from archive..."
                mkdir -p ./build/Payload
                cp -r ./build/App.xcarchive/Products/Applications/*.app ./build/Payload/
                cd ./build
                zip -r App.ipa Payload/
                echo "IPA created manually from archive"
              else
                echo "Cannot find app in archive"
                exit 1
              fi
            }

      - name: Rename and prepare IPA
        run: |
          cd ios/App/build

          # æŸ¥æ‰¾å¹¶é‡å‘½åIPAæ–‡ä»¶
          if [ -f "App.ipa" ]; then
            mv App.ipa AetherLink-unsigned.ipa
            echo "Renamed App.ipa to AetherLink-unsigned.ipa"
          elif [ -f "*.ipa" ]; then
            # å¦‚æœæœ‰å…¶ä»–åç§°çš„IPAæ–‡ä»¶
            for ipa in *.ipa; do
              if [ -f "$ipa" ]; then
                mv "$ipa" AetherLink-unsigned.ipa
                echo "Renamed $ipa to AetherLink-unsigned.ipa"
                break
              fi
            done
          else
            echo "No IPA file found, creating placeholder"
            echo "IPA build failed" > AetherLink-unsigned.ipa.txt
          fi

          # åˆ›å»ºå®‰è£…è¯´æ˜æ–‡ä»¶
          cat > INSTALL_INSTRUCTIONS.md << EOF
          # AetherLink iOS å®‰è£…è¯´æ˜

          ## æ–¹æ³•ä¸€ï¼šä½¿ç”¨ AltStore / SideStore
          1. åœ¨è®¾å¤‡ä¸Šå®‰è£… AltStore æˆ– SideStore
          2. å°† AetherLink-unsigned.ipa æ–‡ä»¶ä¼ è¾“åˆ°è®¾å¤‡
          3. ä½¿ç”¨ AltStore/SideStore å®‰è£… IPA æ–‡ä»¶

          ## æ–¹æ³•äºŒï¼šä½¿ç”¨ Xcode (éœ€è¦å¼€å‘è€…è´¦å·)
          1. åœ¨ Mac ä¸Šæ‰“å¼€ Xcode
          2. è¿æ¥ iOS è®¾å¤‡
          3. å°† IPA æ–‡ä»¶æ‹–æ‹½åˆ° Xcode çš„ Devices and Simulators çª—å£

          ## æ–¹æ³•ä¸‰ï¼šä½¿ç”¨ 3uTools / iMazing
          1. åœ¨ç”µè„‘ä¸Šå®‰è£… 3uTools æˆ– iMazing
          2. è¿æ¥ iOS è®¾å¤‡
          3. ä½¿ç”¨å·¥å…·å®‰è£… IPA æ–‡ä»¶

          ## æ–¹æ³•å››ï¼šä½¿ç”¨ iOS App Signer (é‡æ–°ç­¾å)
          1. ä¸‹è½½ iOS App Signer
          2. ä½¿ç”¨æ‚¨çš„å¼€å‘è€…è¯ä¹¦é‡æ–°ç­¾å IPA
          3. å®‰è£…ç­¾ååçš„ IPA

          ## æ³¨æ„äº‹é¡¹
          - æ­¤ IPA æ–‡ä»¶æœªç­¾åï¼Œéœ€è¦ä½¿ç”¨ç¬¬ä¸‰æ–¹å·¥å…·æˆ–é‡æ–°ç­¾åæ‰èƒ½å®‰è£…
          - å®‰è£…åå¯èƒ½éœ€è¦åœ¨è®¾ç½®ä¸­ä¿¡ä»»å¼€å‘è€…
          - æŸäº›æ–¹æ³•å¯èƒ½éœ€è¦ iOS è®¾å¤‡è¶Šç‹±æˆ–å¼€å‘è€…è´¦å·
          EOF

      - name: Upload IPA and Instructions
        uses: actions/upload-artifact@v4
        with:
          name: ios-app-unsigned
          path: |
            ios/App/build/AetherLink-unsigned.ipa
            ios/App/build/INSTALL_INSTRUCTIONS.md
          retention-days: 30

      - name: Upload Archive (for debugging)
        uses: actions/upload-artifact@v4
        with:
          name: ios-archive
          path: ios/App/build/App.xcarchive
          retention-days: 7

      - name: Get current date
        id: date
        run: echo "date=$(date +'%Y%m%d-%H%M%S')" >> $GITHUB_OUTPUT

      - name: Create Release
        if: (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master') && github.event_name == 'push'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ios-v${{ steps.date.outputs.date }}
          name: iOS Build ${{ steps.date.outputs.date }}
          body: |
            ğŸ è‡ªåŠ¨æ„å»ºçš„ iOS IPA æ–‡ä»¶

            ğŸ“± **æ„å»ºä¿¡æ¯**ï¼š
            - æ„å»ºæ—¶é—´ï¼š${{ steps.date.outputs.date }}
            - æäº¤ï¼š${{ github.sha }}
            - åˆ†æ”¯ï¼š${{ github.ref_name }}

            ğŸ“¦ **ä¸‹è½½æ–‡ä»¶**ï¼š
            - `AetherLink-iOS-${{ steps.date.outputs.date }}.ipa` - iOS åº”ç”¨å®‰è£…åŒ…ï¼ˆæœªç­¾åï¼‰
            - `iOS-å®‰è£…è¯´æ˜-${{ steps.date.outputs.date }}.md` - è¯¦ç»†å®‰è£…è¯´æ˜

            âš ï¸ **é‡è¦æç¤º**ï¼š
            - æ­¤ IPA æ–‡ä»¶æœªç­¾åï¼Œéœ€è¦ä½¿ç”¨ç¬¬ä¸‰æ–¹å·¥å…·å®‰è£…
            - æ¨èä½¿ç”¨ AltStoreã€SideStore æˆ–é‡æ–°ç­¾ååå®‰è£…
            - è¯¦ç»†å®‰è£…æ–¹æ³•è¯·æŸ¥çœ‹è¯´æ˜æ–‡ä»¶

            ğŸ”§ **å®‰è£…æ–¹æ³•**ï¼š
            1. **AltStore/SideStore**ï¼šæœ€ç®€å•çš„å®‰è£…æ–¹å¼
            2. **Xcode**ï¼šéœ€è¦å¼€å‘è€…è´¦å·
            3. **3uTools/iMazing**ï¼šç¬¬ä¸‰æ–¹å·¥å…·
            4. **é‡æ–°ç­¾å**ï¼šä½¿ç”¨ iOS App Signer
          files: |
            ios/App/build/AetherLink-unsigned.ipa
            ios/App/build/INSTALL_INSTRUCTIONS.md
          draft: false
          prerelease: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
